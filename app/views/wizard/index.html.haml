- if current_user!=nil
  %h3
    Help us fill out your Carbon profile!
- else
  %h3
    Try out the Carbon calculator by providing some data anonymously!

#tabs
  %ul#tabList.nav.nav-tabs


%div{:float => "left"}
  #question
  %input#answer.textBox{:type => "number", :hidden => "true"}
  .authform
    #skip.button{:float => "left"}
      Skip
    #next.button
      Next

:javascript
  $(document).ready(function() 
  {
    $('#question').text('Click next to begin answering questions and filling out a basic profile, or choose a tab above to fill out specific information.').addClass('header1');
    initTabs();
  })
  var variables =
    #{
      @factors.to_json
    };
  var categories =
    #{
      @categories.to_json
    }
  var counter = -1;
  var current;
  var questions = {};

  var initTabs = function()
  {
    for(i in categories)
    {
      var category = categories[i];
      var wrapper = $("<li class='button'>");
      var tab = $("<a>");
      var qCounter = 0;
      tab.attr("href", "#"+category.name);
      tab.attr("data-toggle", "tab");
      tab.text(category.name);
      tab.click(function(){
        current = category.name;
        counter = -1;
        displayNextQuestion();
      });
      wrapper.append(tab);
      $("#tabList").append(wrapper);
      questions[variable.name] = [];
      for(x in variables)
      {
        var variable = variables[x];
        if(variable.dependency == 1 && variable.category_id == category.id)
          questions[variable.name][qCounter++] = variable;
      }
    }
  }

  var displayNextQuestion = function()
  {
    var currentQuestions = current ? questions[current] : variables;
    var next;
    while(counter < variables.length - 1 && !next)
      next = currentQuestions[++counter].variableName;

    if(counter < variables.length - 1)
    {
      $('#question').text(next);
      $('#answer').removeAttr('hidden');
      $('#answer').val('');
    }
    else
    {
      $('#question').text("There are no more questions to ask!");
      $('#skip').hide();
      $('#next').hide();
      $('#answer').hide();
    }
  }

  var submitQuestion = function()
  {
    var value = $('#answer').val();
    if(!value)
      return $('#answer').attr('hidden');
    var data = {};
    data.amount = value;
    data.factor_id = variables[counter].id;

    $.ajax({
      type: "POST",
      url: "/create_answer_from_input",
      data: data,
      datatype:"html",
      success: function(data){},
      async: true
    });

    return true;
  }

  $('#next').click(function()
  {
    if(submitQuestion())
      displayNextQuestion();
  });


  $('#skip').click(function()
  {
    displayNextQuestion();
  });
  
